<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teams Recordings</title>
<script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f5f5f5;}
.main-content{padding:30px;}
.section-header{margin-bottom:25px;}
.section-header h1{color:#2c3e50;font-size:26px;margin-bottom:8px;}
.btn{background:#3498db;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px;text-decoration:none;display:inline-block;}
.btn:hover{background:#2980b9;}
.btn.success{background:#27ae60;}
.btn.success:hover{background:#229954;}
.item-card{background:#f8f9fa;padding:15px;margin-bottom:12px;border-radius:6px;border-left:4px solid #3498db;}
.item-title{font-weight:600;color:#2c3e50;margin-bottom:6px;}
.item-meta{color:#7f8c8d;font-size:13px;margin-bottom:10px;}
.loading{text-align:center;padding:40px;color:#7f8c8d;}
.error-msg{background:#f8d7da;color:#721c24;padding:15px;border-radius:6px;margin-bottom:15px;}
.section-divider{margin:40px 0;border-top:2px solid #ddd;}
.debug-box{background:#fff3cd;color:#856404;padding:10px;border-radius:6px;font-size:12px;margin-bottom:10px;word-break:break-all;}
</style>
</head>
<body>

<div class="main-content">

<!-- ================= EXISTING RECORDINGS SECTION ================= -->
<div class="section-header">
<h1>üìπ Teams Recordings</h1>
<p>MP4 files from your specific folder</p>
</div>

<button class="btn" onclick="loadRecordings()">üîÑ Refresh Recordings</button>

<div id="recordingsList" style="margin-top:20px;">
<p class="loading">Click Refresh to load recordings...</p>
</div>

<!-- ================= DIVIDER ================= -->
<div class="section-divider"></div>

<!-- ================= BOT RECORDING SECTION ================= -->
<div class="section-header">
<h1>ü§ñ AutoRecord Bot</h1>
<p>Schedule automatic recordings for your upcoming meetings</p>
</div>

<button class="btn success" onclick="grantCalendarAccess()">üîë Grant Calendar Access</button>
<button class="btn" onclick="loadUpcomingMeetings()">üìÖ Show Upcoming Meetings</button>

<div id="upcomingMeetings" style="margin-top:20px;"></div>

</div>

<script>

/* ================= BACKEND URL ================= */
const BACKEND_URL = "http://localhost:3002"; 
// Change to your deployed URL when live

/* ================= MSAL CONFIG ================= */
const msalConfig = {
  auth: {
    clientId: "4dc5efa6-49cb-4991-9cbf-1867596a2110",
    authority: "https://login.microsoftonline.com/abd34cc0-2911-44eb-abea-713c02c9b3e8",
    redirectUri: window.location.origin + window.location.pathname
  },
  cache:{cacheLocation:"localStorage",storeAuthStateInCookie:true}
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let currentAccount = null;

async function initializeMsal(){
  const response = await msalInstance.handleRedirectPromise();
  if(response){
    currentAccount = response.account;
    msalInstance.setActiveAccount(currentAccount);
  } else {
    const accounts = msalInstance.getAllAccounts();
    if(accounts.length > 0){
      currentAccount = accounts[0];
      msalInstance.setActiveAccount(currentAccount);
    }
  }
}
initializeMsal();

/* ================= TOKEN ================= */
async function getToken(){
  if(!currentAccount){
    const accounts = msalInstance.getAllAccounts();
    if(accounts.length > 0){
      currentAccount = accounts[0];
    } else {
      await msalInstance.loginRedirect({scopes:["User.Read","Files.Read.All"]});
      return;
    }
  }
  const response = await msalInstance.acquireTokenSilent({
    scopes:["User.Read","Files.Read.All"],
    account:currentAccount
  });
  return response.accessToken;
}

/* ================= GRAPH CALL ================= */
async function callGraph(endpoint){
  const token = await getToken();
  if(!token) return null;
  const response = await fetch("https://graph.microsoft.com/v1.0" + endpoint, {
    headers:{Authorization:"Bearer " + token}
  });
  if(!response.ok) throw new Error("Graph API error: " + response.status);
  return response.json();
}

/* ================= DOWNLOAD FUNCTION ================= */
async function downloadFile(itemId, fileName){
  const token = await getToken();
  if(!token) return;
  const response = await fetch(
    `https://graph.microsoft.com/v1.0/me/drive/items/${itemId}/content`,
    { headers:{Authorization:"Bearer " + token} }
  );
  if(!response.ok){ alert("Download failed"); return; }
  const blob = await response.blob();
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  a.remove();
  window.URL.revokeObjectURL(url);
}

/* ================= LOAD RECORDINGS ================= */
async function loadRecordings(){
  const container = document.getElementById("recordingsList");
  container.innerHTML = '<p class="loading">Loading recordings...</p>';
  try{
    const folderId = "015RM5L7QFJSFG3HT6M5E3V2GSYMRC45PL";
    const data = await callGraph(
      `/me/drive/items/${folderId}/children?$select=id,name,size,webUrl,lastModifiedDateTime`
    );
    if(!data || !data.value || data.value.length === 0){
      container.innerHTML = '<p>No recordings found inside folder.</p>';
      return;
    }
    const recordings = data.value.filter(f => f.name.toLowerCase().endsWith(".mp4"));
    container.innerHTML = recordings.map(r => {
      const size = (r.size/1024/1024).toFixed(1) + " MB";
      const date = new Date(r.lastModifiedDateTime).toLocaleString();
      return `
        <div class="item-card">
          <div class="item-title">${r.name}</div>
          <div style="font-size:12px;color:#444;margin-bottom:6px;">
            <strong>Item ID:</strong><br>${r.id}
          </div>
          <div class="item-meta">Size: ${size} | Date: ${date}</div>
          <button class="btn" onclick="downloadFile('${r.id}','${r.name}')">Download MP4</button>
          <a href="${r.webUrl}" target="_blank" class="btn">Open in OneDrive</a>
        </div>
      `;
    }).join("");
  } catch(error){
    container.innerHTML = '<div class="error-msg">Error: ' + error.message + '</div>';
  }
}

/* ================= HELPER: Stringify any error safely ================= */
function stringifyError(err) {
  if (!err) return 'Unknown error';
  if (typeof err === 'string') return err;
  if (typeof err === 'object') {
    // Try common fields first
    if (err.message) return err.message;
    if (err.error_description) return err.error_description;
    if (err.error) return typeof err.error === 'string' ? err.error : JSON.stringify(err.error);
    return JSON.stringify(err);
  }
  return String(err);
}

/* ================= GRANT CALENDAR ACCESS ================= */
async function grantCalendarAccess() {
  if (!currentAccount) {
    alert('Please sign in first by clicking "Refresh Recordings"');
    return;
  }
  const userId = currentAccount.homeAccountId;
  localStorage.setItem('botUserId', userId);
  window.open(
    `${BACKEND_URL}/api/auth/grant?userId=${encodeURIComponent(userId)}`,
    '_blank',
    'width=600,height=700'
  );
  setTimeout(() => {
    alert('‚úÖ After granting access in the popup, click "Show Upcoming Meetings"');
  }, 1000);
}

/* ================= LOAD UPCOMING MEETINGS ================= */
async function loadUpcomingMeetings() {
  const container = document.getElementById('upcomingMeetings');
  container.innerHTML = '<p class="loading">Loading your upcoming meetings...</p>';

  const userId = localStorage.getItem('botUserId');
  if (!userId) {
    container.innerHTML = '<div class="error-msg">Please grant calendar access first!<br><button class="btn" onclick="grantCalendarAccess()">Grant Access Now</button></div>';
    return;
  }

  try {
    const response = await fetch(`${BACKEND_URL}/api/meetings?userId=${encodeURIComponent(userId)}`);

    // Handle non-JSON or server errors
    const rawText = await response.text();
    console.log('Raw API response:', rawText);

    let data;
    try {
      data = JSON.parse(rawText);
    } catch(parseErr) {
      container.innerHTML = `
        <div class="error-msg">Server returned invalid JSON.<br>
        <div class="debug-box">${rawText.substring(0, 500)}</div>
        <button class="btn" onclick="grantCalendarAccess()">Grant Access Again</button></div>`;
      return;
    }

    console.log('Parsed API response:', data);

    if (!data.success) {
      // FIX: properly convert error to string no matter what type it is
      const errMsg = stringifyError(data.error);
      container.innerHTML = `
        <div class="error-msg">
          <strong>API Error:</strong> ${errMsg}
          <div class="debug-box">Full response: ${JSON.stringify(data)}</div>
          <button class="btn" onclick="grantCalendarAccess()">Grant Access Again</button>
        </div>`;
      return;
    }

    if (!data.meetings || data.meetings.length === 0) {
      container.innerHTML = '<p>No upcoming Teams meetings found in the next 24 hours.</p>';
      return;
    }

    container.innerHTML = `
      <p style="margin-bottom:15px;color:#555;font-weight:600;">Found ${data.total} upcoming meeting(s)</p>
    ` + data.meetings.map(m => {
      const meetingName = m.meetingName || 'Untitled Meeting';
      const startTime = m.startTime ? new Date(m.startTime).toLocaleString() : 'Unknown time';
      const joinUrl = m.joinUrl || '';
      const safeId = encodeURIComponent(m.meetingId || '');
      const safeUrl = encodeURIComponent(joinUrl);
      const safeName = encodeURIComponent(meetingName);

      return `
        <div class="item-card">
          <div class="item-title">üìÖ ${escapeHtml(meetingName)}</div>
          <div class="item-meta">Starts: ${startTime}</div>
          ${joinUrl
            ? `<button class="btn success"
                onclick="startBotRecording(decodeURIComponent('${safeId}'), decodeURIComponent('${safeUrl}'), decodeURIComponent('${safeName}'))">
                üé• Record This Meeting
              </button>`
            : '<p style="color:#e74c3c;font-size:12px;">No join URL available</p>'
          }
        </div>
      `;
    }).join('');

  } catch (error) {
    console.error('Error loading meetings:', error);
    container.innerHTML = `<div class="error-msg">
      Network/fetch error: ${error.message}<br>
      <small>Make sure backend is running at: ${BACKEND_URL}</small>
    </div>`;
  }
}

/* ================= ESCAPE HTML ================= */
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = String(text || '');
  return div.innerHTML;
}

/* ================= START BOT RECORDING ================= */
async function startBotRecording(meetingId, meetingUrl, meetingName) {
  const userId = localStorage.getItem('botUserId');
  if (!confirm(`Start recording "${meetingName}"?`)) return;

  try {
    const response = await fetch(`${BACKEND_URL}/api/record/start`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, meetingId, meetingUrl, meetingName })
    });

    const rawText = await response.text();
    let data;
    try { data = JSON.parse(rawText); }
    catch(e) { alert('Server error: ' + rawText.substring(0, 200)); return; }

    if (data.success) {
      alert(`‚úÖ Recording started!\n\nRecording ID: ${data.recordingId}\n\nThe bot will join the meeting and upload to Google Drive when finished.`);
      const statusHtml = `
        <div class="item-card" style="border-left-color:#27ae60;">
          <div class="item-title">üé• Recording in Progress</div>
          <div class="item-meta">
            Meeting: ${escapeHtml(meetingName)}<br>
            Recording ID: ${data.recordingId}
          </div>
          <button class="btn" onclick="checkRecordingStatus('${data.recordingId}')">Check Status</button>
        </div>
      `;
      document.getElementById('upcomingMeetings').insertAdjacentHTML('afterbegin', statusHtml);
    } else {
      alert('‚ùå Failed to start recording: ' + stringifyError(data.error));
    }
  } catch (error) {
    alert('‚ùå Error: ' + error.message);
  }
}

/* ================= CHECK RECORDING STATUS ================= */
async function checkRecordingStatus(recordingId) {
  try {
    const response = await fetch(`${BACKEND_URL}/api/record/status/${recordingId}`);
    const data = await response.json();
    let message = `Recording Status: ${data.status}\n\n`;
    if (data.status === 'completed' && data.googleDriveLink) {
      message += `‚úÖ Recording completed!\n\nGoogle Drive: ${data.googleDriveLink}`;
      if (confirm(message + '\n\nOpen in Google Drive?')) {
        window.open(data.googleDriveLink, '_blank');
      }
    } else if (data.status === 'failed') {
      message += `‚ùå Recording failed\n\nError: ${stringifyError(data.error)}`;
      alert(message);
    } else {
      message += `‚è≥ Still recording...\n\nStarted: ${new Date(data.startTime).toLocaleString()}`;
      alert(message);
    }
  } catch (error) {
    alert('Error checking status: ' + error.message);
  }
}

</script>
</body>
</html>
