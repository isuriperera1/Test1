<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teams Recordings</title>
<script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f5f5f5;}
.main-content{padding:30px;}
.section-header{margin-bottom:25px;}
.section-header h1{color:#2c3e50;font-size:26px;margin-bottom:8px;}
.btn{background:#3498db;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px;}
.btn:hover{background:#2980b9;}
.item-card{background:#f8f9fa;padding:15px;margin-bottom:12px;border-radius:6px;border-left:4px solid #3498db;}
.item-title{font-weight:600;color:#2c3e50;margin-bottom:6px;}
.item-meta{color:#7f8c8d;font-size:13px;margin-bottom:10px;}
.loading{text-align:center;padding:40px;color:#7f8c8d;}
.error-msg{background:#f8d7da;color:#721c24;padding:15px;border-radius:6px;margin-bottom:15px;}
</style>
</head>
<body>

<div class="main-content">
<div class="section-header">
<h1>Teams Recordings</h1>
<p>MP4 files from your specific folder</p>
</div>

<button class="btn" onclick="loadRecordings()">Refresh Recordings</button>

<div id="recordingsList" style="margin-top:20px;">
<p class="loading">Click Refresh to load recordings...</p>
</div>
</div>

<script>

/* ================= MSAL CONFIG ================= */

const msalConfig = {
auth: {
clientId: "4dc5efa6-49cb-4991-9cbf-1867596a2110",
authority: "https://login.microsoftonline.com/abd34cc0-2911-44eb-abea-713c02c9b3e8",
redirectUri: window.location.origin + window.location.pathname
},
cache:{cacheLocation:"localStorage",storeAuthStateInCookie:true}
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let currentAccount = null;

async function initializeMsal(){
const response = await msalInstance.handleRedirectPromise();
if(response){
currentAccount=response.account;
msalInstance.setActiveAccount(currentAccount);
}else{
const accounts=msalInstance.getAllAccounts();
if(accounts.length>0){
currentAccount=accounts[0];
msalInstance.setActiveAccount(currentAccount);
}
}
}
initializeMsal();

/* ================= TOKEN ================= */

async function getToken(){
if(!currentAccount){
const accounts=msalInstance.getAllAccounts();
if(accounts.length>0){
currentAccount=accounts[0];
}else{
await msalInstance.loginRedirect({scopes:["User.Read","Files.Read.All"]});
return;
}
}

const response=await msalInstance.acquireTokenSilent({
scopes:["User.Read","Files.Read.All"],
account:currentAccount
});
return response.accessToken;
}

/* ================= GRAPH CALL ================= */

async function callGraph(endpoint){
const token=await getToken();
if(!token)return null;

const response=await fetch("https://graph.microsoft.com/v1.0"+endpoint,{
headers:{Authorization:"Bearer "+token}
});

if(!response.ok)throw new Error("Graph API error: "+response.status);
return response.json();
}

/* ================= DOWNLOAD FUNCTION ================= */

async function downloadFile(itemId,fileName){

const token=await getToken();
if(!token)return;

const response=await fetch(
`https://graph.microsoft.com/v1.0/me/drive/items/${itemId}/content`,
{
headers:{Authorization:"Bearer "+token}
}
);

if(!response.ok){
alert("Download failed");
return;
}

const blob=await response.blob();
const url=window.URL.createObjectURL(blob);

const a=document.createElement("a");
a.href=url;
a.download=fileName;
document.body.appendChild(a);
a.click();
a.remove();

window.URL.revokeObjectURL(url);
}

/* ================= LOAD RECORDINGS ================= */

async function loadRecordings(){

const container=document.getElementById("recordingsList");
container.innerHTML='<p class="loading">Loading recordings...</p>';

try{

const folderId="015RM5L7QFJSFG3HT6M5E3V2GSYMRC45PL";

const data=await callGraph(
`/me/drive/items/${folderId}/children?$select=id,name,size,webUrl,lastModifiedDateTime`
);

if(!data||!data.value||data.value.length===0){
container.innerHTML='<p>No recordings found inside folder.</p>';
return;
}

const recordings=data.value.filter(f=>f.name.toLowerCase().endsWith(".mp4"));

container.innerHTML=recordings.map(r=>{

const size=(r.size/1024/1024).toFixed(1)+" MB";
const date=new Date(r.lastModifiedDateTime).toLocaleString();

return `
<div class="item-card">

<div class="item-title">${r.name}</div>

<div style="font-size:12px;color:#444;margin-bottom:6px;">
<strong>Item ID:</strong><br>
${r.id}
</div>

<div class="item-meta">
Size: ${size} | Date: ${date}
</div>

<button class="btn"
onclick="downloadFile('${r.id}','${r.name}')">
Download MP4
</button>

<a href="${r.webUrl}" target="_blank" class="btn">
Open in OneDrive
</a>

</div>
`;

}).join("");

}catch(error){
container.innerHTML='<div class="error-msg">Error: '+error.message+'</div>';
}
}

</script>
</body>
</html>
