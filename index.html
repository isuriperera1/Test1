<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teams Recordings</title>
<script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',Tahoma,sans-serif;background:#f5f5f5;}
.main-content{padding:30px;}
.section-header{margin-bottom:25px;}
.section-header h1{color:#2c3e50;font-size:26px;margin-bottom:8px;}
.btn{background:#3498db;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;margin-right:8px;text-decoration:none;display:inline-block;}
.btn:hover{background:#2980b9;}
.btn.success{background:#27ae60;}
.btn.success:hover{background:#229954;}
.item-card{background:#f8f9fa;padding:15px;margin-bottom:12px;border-radius:6px;border-left:4px solid #3498db;}
.item-title{font-weight:600;color:#2c3e50;margin-bottom:6px;}
.item-meta{color:#7f8c8d;font-size:13px;margin-bottom:10px;}
.loading{text-align:center;padding:40px;color:#7f8c8d;}
.error-msg{background:#f8d7da;color:#721c24;padding:15px;border-radius:6px;margin-bottom:15px;}
.section-divider{margin:40px 0;border-top:2px solid #ddd;}
</style>
</head>
<body>

<div class="main-content">

<!-- ================= EXISTING RECORDINGS SECTION ================= -->
<div class="section-header">
<h1>üìπ Teams Recordings</h1>
<p>MP4 files from your specific folder</p>
</div>

<button class="btn" onclick="loadRecordings()">üîÑ Refresh Recordings</button>

<div id="recordingsList" style="margin-top:20px;">
<p class="loading">Click Refresh to load recordings...</p>
</div>

<!-- ================= DIVIDER ================= -->
<div class="section-divider"></div>

<!-- ================= BOT RECORDING SECTION ================= -->
<div class="section-header">
<h1>ü§ñ AutoRecord Bot</h1>
<p>Schedule automatic recordings for your upcoming meetings</p>
</div>

<button class="btn success" onclick="grantCalendarAccess()">üîë Grant Calendar Access</button>
<button class="btn" onclick="loadUpcomingMeetings()">üìÖ Show Upcoming Meetings</button>

<div id="upcomingMeetings" style="margin-top:20px;"></div>

</div>

<script>

/* ================= BACKEND URL ================= */
const BACKEND_URL = "http://localhost:3002"; 
// Change to: https://your-app.onrender.com when deployed

/* ================= MSAL CONFIG ================= */

const msalConfig = {
auth: {
clientId: "4dc5efa6-49cb-4991-9cbf-1867596a2110",
authority: "https://login.microsoftonline.com/abd34cc0-2911-44eb-abea-713c02c9b3e8",
redirectUri: window.location.origin + window.location.pathname
},
cache:{cacheLocation:"localStorage",storeAuthStateInCookie:true}
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let currentAccount = null;

async function initializeMsal(){
const response = await msalInstance.handleRedirectPromise();
if(response){
currentAccount=response.account;
msalInstance.setActiveAccount(currentAccount);
}else{
const accounts=msalInstance.getAllAccounts();
if(accounts.length>0){
currentAccount=accounts[0];
msalInstance.setActiveAccount(currentAccount);
}
}
}
initializeMsal();

/* ================= TOKEN ================= */

async function getToken(){
if(!currentAccount){
const accounts=msalInstance.getAllAccounts();
if(accounts.length>0){
currentAccount=accounts[0];
}else{
await msalInstance.loginRedirect({scopes:["User.Read","Files.Read.All"]});
return;
}
}

const response=await msalInstance.acquireTokenSilent({
scopes:["User.Read","Files.Read.All"],
account:currentAccount
});
return response.accessToken;
}

/* ================= GRAPH CALL ================= */

async function callGraph(endpoint){
const token=await getToken();
if(!token)return null;

const response=await fetch("https://graph.microsoft.com/v1.0"+endpoint,{
headers:{Authorization:"Bearer "+token}
});

if(!response.ok)throw new Error("Graph API error: "+response.status);
return response.json();
}

/* ================= DOWNLOAD FUNCTION ================= */

async function downloadFile(itemId,fileName){
const token=await getToken();
if(!token)return;

const response=await fetch(
`https://graph.microsoft.com/v1.0/me/drive/items/${itemId}/content`,
{ headers:{Authorization:"Bearer "+token} }
);

if(!response.ok){
alert("Download failed");
return;
}

const blob=await response.blob();
const url=window.URL.createObjectURL(blob);

const a=document.createElement("a");
a.href=url;
a.download=fileName;
document.body.appendChild(a);
a.click();
a.remove();

window.URL.revokeObjectURL(url);
}

/* ================= LOAD RECORDINGS ================= */

async function loadRecordings(){
const container=document.getElementById("recordingsList");
container.innerHTML='<p class="loading">Loading recordings...</p>';

try{
const folderId="015RM5L7QFJSFG3HT6M5E3V2GSYMRC45PL";
const data=await callGraph(
`/me/drive/items/${folderId}/children?$select=id,name,size,webUrl,lastModifiedDateTime`
);

if(!data||!data.value||data.value.length===0){
container.innerHTML='<p>No recordings found inside folder.</p>';
return;
}

const recordings=data.value.filter(f=>f.name.toLowerCase().endsWith(".mp4"));

container.innerHTML=recordings.map(r=>{
const size=(r.size/1024/1024).toFixed(1)+" MB";
const date=new Date(r.lastModifiedDateTime).toLocaleString();

return `
<div class="item-card">
<div class="item-title">${r.name}</div>
<div style="font-size:12px;color:#444;margin-bottom:6px;">
<strong>Item ID:</strong><br>${r.id}
</div>
<div class="item-meta">Size: ${size} | Date: ${date}</div>
<button class="btn" onclick="downloadFile('${r.id}','${r.name}')">Download MP4</button>
<a href="${r.webUrl}" target="_blank" class="btn">Open in OneDrive</a>
</div>
`;
}).join("");

}catch(error){
container.innerHTML='<div class="error-msg">Error: '+error.message+'</div>';
}
}

/* ================= BOT RECORDING FUNCTIONS ================= */

// Grant calendar access
async function grantCalendarAccess() {
    if (!currentAccount) {
        alert('Please sign in first by clicking "Refresh Recordings"');
        return;
    }
    
    const userId = currentAccount.homeAccountId;
    localStorage.setItem('botUserId', userId);
    
    window.open(
        `${BACKEND_URL}/api/auth/grant?userId=${encodeURIComponent(userId)}`, 
        '_blank', 
        'width=600,height=700'
    );
    
    setTimeout(() => {
        alert('‚úÖ After granting access, click "Show Upcoming Meetings"');
    }, 1000);
}

// Load upcoming meetings
async function loadUpcomingMeetings() {
    const container = document.getElementById('upcomingMeetings');
    container.innerHTML = '<p class="loading">Loading your upcoming meetings...</p>';
    
    const userId = localStorage.getItem('botUserId');
    if (!userId) {
        container.innerHTML = '<div class="error-msg">Please grant calendar access first!<br><button class="btn" onclick="grantCalendarAccess()">Grant Access Now</button></div>';
        return;
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/meetings?userId=${encodeURIComponent(userId)}`);
        const data = await response.json();
        
        console.log('API Response:', data); // Debug
        
        if (!data.success) {
            container.innerHTML = `<div class="error-msg">${data.error || 'Unknown error'}<br><button class="btn" onclick="grantCalendarAccess()">Grant Access Again</button></div>`;
            return;
        }
        
        if (!data.meetings || data.meetings.length === 0) {
            container.innerHTML = '<p>No upcoming Teams meetings found in the next 24 hours.</p>';
            return;
        }
        
        container.innerHTML = `
            <p style="margin-bottom:15px;color:#555;font-weight:600;">Found ${data.total} upcoming meeting(s)</p>
        ` + data.meetings.map(m => {
            const meetingName = m.meetingName || 'Untitled Meeting';
            const startTime = m.startTime ? new Date(m.startTime).toLocaleString() : 'Unknown time';
            const joinUrl = m.joinUrl || '';
            
            return `
                <div class="item-card">
                    <div class="item-title">üìÖ ${escapeHtml(meetingName)}</div>
                    <div class="item-meta">
                        Starts: ${startTime}
                    </div>
                    ${joinUrl ? `
                        <button class="btn success" 
                        onclick="startBotRecording('${escapeHtml(m.meetingId)}', '${escapeHtml(joinUrl)}', '${escapeHtml(meetingName)}')">
                            üé• Record This Meeting
                        </button>
                    ` : '<p style="color:#e74c3c;font-size:12px;">No join URL available</p>'}
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading meetings:', error);
        container.innerHTML = '<div class="error-msg">Error: ' + error.message + '<br><small>Make sure backend is running at: ' + BACKEND_URL + '</small></div>';
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Start bot recording
async function startBotRecording(meetingId, meetingUrl, meetingName) {
    const userId = localStorage.getItem('botUserId');
    
    if (!confirm(`Start recording "${meetingName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`${BACKEND_URL}/api/record/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                userId: userId,
                meetingId: meetingId,
                meetingUrl: meetingUrl,
                meetingName: meetingName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Recording started!\n\nRecording ID: ${data.recordingId}\n\nThe bot will join the meeting and upload to Google Drive when finished.`);
            
            // Show status checker
            const statusHtml = `
                <div class="item-card" style="border-left-color:#27ae60;">
                    <div class="item-title">üé• Recording in Progress</div>
                    <div class="item-meta">
                        Meeting: ${meetingName}<br>
                        Recording ID: ${data.recordingId}
                    </div>
                    <button class="btn" onclick="checkRecordingStatus('${data.recordingId}')">Check Status</button>
                </div>
            `;
            document.getElementById('upcomingMeetings').insertAdjacentHTML('afterbegin', statusHtml);
        } else {
            alert('‚ùå Failed to start recording: ' + (data.error || 'Unknown error'));
        }
        
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

// Check recording status
async function checkRecordingStatus(recordingId) {
    try {
        const response = await fetch(`${BACKEND_URL}/api/record/status/${recordingId}`);
        const data = await response.json();
        
        let message = `Recording Status: ${data.status}\n\n`;
        
        if (data.status === 'completed' && data.googleDriveLink) {
            message += `‚úÖ Recording completed!\n\nGoogle Drive: ${data.googleDriveLink}`;
            
            // Offer to open link
            if (confirm(message + '\n\nOpen in Google Drive?')) {
                window.open(data.googleDriveLink, '_blank');
            }
        } else if (data.status === 'failed') {
            message += `‚ùå Recording failed\n\nError: ${data.error}`;
            alert(message);
        } else {
            message += `‚è≥ Still recording...\n\nStarted: ${new Date(data.startTime).toLocaleString()}`;
            alert(message);
        }
        
    } catch (error) {
        alert('Error checking status: ' + error.message);
    }
}

</script>
</body>
</html>
