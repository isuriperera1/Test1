<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teams Recording Bot - Setup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #f5f5f5; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background: #2c3e50; color: white; padding: 0; position: relative; }
        .sidebar-header { padding: 20px; background: #34495e; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header h2 { margin: 0; font-size: 18px; font-weight: 600; }
        .profile-section { position: relative; }
        .profile-icon { width: 32px; height: 32px; background: #3498db; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
        .profile-icon:hover { background: #2980b9; }
        .profile-icon svg { width: 20px; height: 20px; color: white; }
        .profile-dropdown { position: absolute; top: 40px; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 240px; z-index: 1000; display: none; }
        .profile-item { padding: 12px 16px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; }
        .profile-user { display: flex; align-items: center; gap: 10px; padding: 16px; }
        .profile-user img { width: 32px; height: 32px; border-radius: 50%; }
        .profile-user-info h4 { margin: 0; font-size: 14px; color: #333; }
        .profile-user-info p { margin: 0; font-size: 12px; color: #666; }
        .profile-action { padding: 16px; }
        .profile-action .btn { width: 100%; padding: 8px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .profile-action .btn:hover { background: #2980b9; }
        .profile-action .btn.danger { background: #e74c3c; }
        .profile-action .btn.danger:hover { background: #c0392b; }
        .sidebar-nav { padding: 20px 0; }
        .nav-item { display: block; width: 100%; padding: 12px 20px; background: none; border: none; color: white; text-align: left; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .nav-item:hover { background: #34495e; }
        .nav-item.active { background: #3498db; }
        .main-content { flex: 1; padding: 0; }
        .content-section { display: none; padding: 30px; }
        .content-section.active { display: block; }
        .section-header { margin-bottom: 30px; }
        .section-header h1 { color: #2c3e50; font-size: 28px; font-weight: 600; margin-bottom: 8px; }
        .section-header p { color: #7f8c8d; font-size: 16px; }
        .status-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .status-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; }
        .status-card h3 { margin-bottom: 10px; color: #2c3e50; }
        .status-text { font-size: 14px; color: #7f8c8d; }
        .status-card.connected .status-text { color: #27ae60; font-weight: 600; }
        .status-card.error .status-text { color: #e74c3c; font-weight: 600; }
        .status-card.checking .status-text { color: #f39c12; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; color: #2c3e50; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .btn { background: #3498db; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: background 0.2s; }
        .btn:hover { background: #2980b9; }
        .btn.success { background: #27ae60; }
        .btn.success:hover { background: #229954; }
        .feature-list { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .feature-list h3 { margin-bottom: 15px; color: #2c3e50; }
        .feature-list ul { list-style: none; }
        .feature-list li { margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #f8f9fa; }
        .calendar-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .calendar-events { margin-top: 20px; }
        .calendar-event { background: #f8f9fa; padding: 15px; margin-bottom: 10px; border-radius: 6px; border-left: 4px solid #3498db; }
        .event-title { font-weight: 600; color: #2c3e50; margin-bottom: 5px; }
        .event-time { color: #7f8c8d; font-size: 14px; margin-bottom: 5px; }
        .event-type { display: inline-block; background: #3498db; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-right: 5px; }
        .auth-notice { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 6px; margin-bottom: 20px; text-align: center; }
        .auth-notice button { margin-top: 10px; }
        .success-notice { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
        .error-notice { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; padding: 15px; border-radius: 6px; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>Setup Panel</h2>
                <div class="profile-section">
                    <div class="profile-icon" onclick="toggleProfileDropdown()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="profile-dropdown" id="profileDropdown">
                        <div id="profileContent">
                            <div class="profile-item">Not signed in</div>
                            <div class="profile-action">
                                <button onclick="loginToMicrosoft()" class="btn">Sign in with Microsoft</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showSection('dashboard')">Dashboard</button>
                <button class="nav-item" onclick="showSection('azure')">Azure AD</button>
                <button class="nav-item" onclick="showSection('storage')">Storage</button>
                <button class="nav-item" onclick="showSection('recordings')">OneDrive Recordings</button>
                <button class="nav-item" onclick="showSection('calendar')">Calendar</button>
                <button class="nav-item" onclick="showSection('tts')">Text-to-Speech</button>
                <button class="nav-item" onclick="showSection('n8n')">N8N Webhook</button>
                <button class="nav-item" onclick="showSection('database')">Database</button>
                <button class="nav-item" onclick="showSection('redis')">Redis</button>
            </nav>
        </aside>
        <main class="main-content">
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1>Configuration Dashboard</h1>
                    <p>Multi-tenant Teams Recording Bot - Bots auto-generate with unique IDs</p>
                </div>
                <div class="status-grid">
                    <div class="status-card checking" id="status-azure"><h3>Azure AD</h3><p class="status-text">Checking...</p></div>
                    <div class="status-card checking" id="status-storage"><h3>Storage</h3><p class="status-text">Checking...</p></div>
                    <div class="status-card checking" id="status-tts"><h3>TTS</h3><p class="status-text">Checking...</p></div>
                    <div class="status-card checking" id="status-n8n"><h3>N8N</h3><p class="status-text">Checking...</p></div>
                    <div class="status-card checking" id="status-database"><h3>Database</h3><p class="status-text">Checking...</p></div>
                    <div class="status-card checking" id="status-redis"><h3>Redis</h3><p class="status-text">Checking...</p></div>
                </div>
                <div class="feature-list">
                    <h3>Key Features</h3>
                    <ul>
                        <li><strong>Bots auto-generate</strong> with unique IDs per tenant</li>
                        <li><strong>Delegate permissions</strong> only - uses user consent flow</li>
                        <li><strong>Multiple storage</strong>: Supabase, Google Drive, Local</li>
                        <li><strong>TTS</strong>: Eleven Labs or Azure Speech</li>
                        <li><strong>N8N</strong>: Webhook triggered on recording complete</li>
                        <li><strong>Calendar Integration</strong>: View and monitor Teams meetings</li>
                    </ul>
                </div>
            </section>

            <section id="azure" class="content-section">
                <div class="section-header">
                    <h1>Azure AD Configuration</h1>
                    <p>Configure Azure Active Directory settings for Microsoft Graph access</p>
                </div>
                <div class="form-group">
                    <label for="azure-tenant-id">Tenant ID</label>
                    <input type="text" id="azure-tenant-id" placeholder="Your Azure AD Tenant ID" value="abd34cc0-2911-44eb-abea-713c02c9b3e8">
                </div>
                <div class="form-group">
                    <label for="azure-client-id">Client ID</label>
                    <input type="text" id="azure-client-id" placeholder="Your Application Client ID" value="4dc5efa6-49cb-4991-9cbf-1867596a2110">
                </div>
                <div class="form-group">
                    <label for="azure-client-secret">Client Secret</label>
                    <input type="password" id="azure-client-secret" placeholder="Your Application Client Secret" value="vqs8Q~s1bjrgYq1T8XV1lcySV_gwf9~DhXJEQcV~">
                </div>
                <button class="btn" onclick="saveAzureConfig()">Save Azure Configuration</button>
                <div id="azureConfigResult"></div>
            </section>

            <section id="storage" class="content-section">
                <div class="section-header">
                    <h1>Storage Configuration</h1>
                    <p>Configure storage settings for recordings and transcripts</p>
                </div>
                <div class="form-group">
                    <label for="storage-type">Storage Type</label>
                    <select id="storage-type">
                        <option value="supabase">Supabase</option>
                        <option value="google-drive">Google Drive</option>
                        <option value="local">Local Storage</option>
                    </select>
                </div>
                <div id="supabase-config">
                    <div class="form-group">
                        <label for="supabase-url">Supabase URL</label>
                        <input type="text" id="supabase-url" placeholder="https://your-project.supabase.co" value="https://fhrubwidcdokgshsnnep.supabase.co">
                    </div>
                    <div class="form-group">
                        <label for="supabase-key">Service Role Key</label>
                        <input type="password" id="supabase-key" placeholder="Your Supabase service role key">
                    </div>
                    <div class="form-group">
                        <label for="supabase-bucket">Storage Bucket</label>
                        <input type="text" id="supabase-bucket" placeholder="recordings" value="Tip">
                    </div>
                </div>
                <button class="btn" onclick="saveStorageConfig()">Save Storage Configuration</button>
                <div id="storageConfigResult"></div>
            </section>

            <section id="recordings" class="content-section">
                <div class="section-header">
                    <h1>OneDrive Recordings</h1>
                    <p>Access Teams meeting recordings from OneDrive with delegated permissions</p>
                </div>
                
                <div id="recordingsAuthNotice" class="auth-notice" style="display: none;">
                    <p>Please sign in with your Microsoft account to access OneDrive recordings.</p>
                    <button onclick="loginToMicrosoft()" class="btn">Sign in with Microsoft</button>
                </div>
                
                <div class="success-notice" style="margin-bottom: 20px;">
                    <strong>n8n Integration:</strong> Use these API endpoints to fetch recordings:
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        <li><code>GET /api/v1/recordings</code> - List all recordings</li>
                        <li><code>GET /api/v1/recordings/:id</code> - Get specific recording details</li>
                        <li><code>GET /api/v1/recordings/:id/download</code> - Download recording file</li>
                        <li><code>GET /api/v1/recordings/:id/transcript</code> - Get transcript if available</li>
                    </ul>
                </div>
                
                <div class="calendar-container">
                    <h3>Your OneDrive Recordings</h3>
                    <button class="btn" onclick="loadRecordings()">Refresh Recordings</button>
                    <div class="calendar-events" id="recordingsList">
                        <p>Click "Refresh Recordings" to load your OneDrive recordings...</p>
                    </div>
                </div>
            </section>

            <section id="calendar" class="content-section">
                <div class="section-header">
                    <h1>Calendar Integration</h1>
                    <p>View your Microsoft Teams calendar events and upcoming meetings</p>
                </div>
                
                <div id="calendarAuthNotice" class="auth-notice" style="display: none;">
                    <p>Please sign in with your Microsoft account to view your calendar events.</p>
                    <button onclick="loginToMicrosoft()" class="btn">Sign in with Microsoft</button>
                    <button onclick="loginDirectly()" class="btn" style="background: #e67e22;">Direct Sign In</button>
                </div>
                
                <div class="calendar-container">
                    <h3>Upcoming Teams Meetings</h3>
                    <button class="btn" onclick="loadCalendarEvents()">Refresh Calendar</button>
                    <div class="calendar-events" id="calendarEvents">
                        <p>Loading calendar events...</p>
                    </div>
                </div>
            </section>

            <section id="tts" class="content-section">
                <div class="section-header">
                    <h1>Text-to-Speech Configuration</h1>
                    <p>Configure TTS settings for audio notifications</p>
                </div>
                <div class="form-group">
                    <label for="tts-provider">TTS Provider</label>
                    <select id="tts-provider">
                        <option value="elevenlabs">Eleven Labs</option>
                        <option value="azure">Azure Speech</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tts-api-key">API Key</label>
                    <input type="password" id="tts-api-key" placeholder="Your TTS API key">
                </div>
                <button class="btn" onclick="saveTTSConfig()">Save TTS Configuration</button>
                <div id="ttsConfigResult"></div>
            </section>

            <section id="n8n" class="content-section">
                <div class="section-header">
                    <h1>N8N Webhook Configuration</h1>
                    <p>Configure N8N webhook for recording completion notifications</p>
                </div>
                <div class="form-group">
                    <label for="n8n-webhook-url">Webhook URL</label>
                    <input type="url" id="n8n-webhook-url" placeholder="https://your-n8n-instance.com/webhook/...">
                </div>
                <button class="btn" onclick="saveN8NConfig()">Save N8N Configuration</button>
                <div id="n8nConfigResult"></div>
            </section>

            <section id="database" class="content-section">
                <div class="section-header">
                    <h1>Database Configuration</h1>
                    <p>Configure PostgreSQL database settings</p>
                </div>
                <div class="form-group">
                    <label for="db-host">Host</label>
                    <input type="text" id="db-host" placeholder="localhost" value="ep-calm-violet-a8dtvffw-pooler.eastus2.azure.neon.tech">
                </div>
                <div class="form-group">
                    <label for="db-port">Port</label>
                    <input type="number" id="db-port" placeholder="5432" value="5432">
                </div>
                <div class="form-group">
                    <label for="db-name">Database Name</label>
                    <input type="text" id="db-name" placeholder="teams_recording_bot" value="neondb">
                </div>
                <div class="form-group">
                    <label for="db-username">Username</label>
                    <input type="text" id="db-username" placeholder="postgres" value="neondb_owner">
                </div>
                <div class="form-group">
                    <label for="db-password">Password</label>
                    <input type="password" id="db-password" placeholder="Your database password">
                </div>
                <button class="btn" onclick="saveDatabaseConfig()">Save Database Configuration</button>
                <div id="databaseConfigResult"></div>
            </section>

            <section id="redis" class="content-section">
                <div class="section-header">
                    <h1>Redis Configuration</h1>
                    <p>Configure Redis for caching and session management</p>
                </div>
                <div class="form-group">
                    <label for="redis-host">Host</label>
                    <input type="text" id="redis-host" placeholder="localhost" value="localhost">
                </div>
                <div class="form-group">
                    <label for="redis-port">Port</label>
                    <input type="number" id="redis-port" placeholder="6379" value="6379">
                </div>
                <div class="form-group">
                    <label for="redis-password">Password (optional)</label>
                    <input type="password" id="redis-password" placeholder="Redis password">
                </div>
                <button class="btn" onclick="saveRedisConfig()">Save Redis Configuration</button>
                <div id="redisConfigResult"></div>
            </section>
        </main>
    </div>

    <script>
        let profileDropdownOpen = false;

        function showSection(sectionName) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            profileDropdownOpen = !profileDropdownOpen;
            dropdown.style.display = profileDropdownOpen ? 'block' : 'none';
            
            if (profileDropdownOpen) {
                checkAuthStatus();
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileSection = event.target.closest('.profile-section');
            if (!profileSection && profileDropdownOpen) {
                document.getElementById('profileDropdown').style.display = 'none';
                profileDropdownOpen = false;
            }
        });

        function loginToMicrosoft() {
            console.log('Starting Microsoft login...');
            fetch('/api/v1/auth/login')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Login response:', data);
                    if (data.authUrl) {
                        console.log('Opening authentication popup...');
                        const popup = window.open(data.authUrl, 'microsoftAuth', 
                            'width=500,height=600,scrollbars=yes,resizable=yes,centerscreen=yes');
                        
                        if (!popup) {
                            alert('Popup was blocked. Please allow popups and try again, or use Direct Sign In.');
                            return;
                        }
                        
                        const checkClosed = setInterval(function() {
                            if (popup.closed) {
                                clearInterval(checkClosed);
                                console.log('Popup closed, refreshing status...');
                                setTimeout(() => {
                                    checkAuthStatus();
                                    loadCalendarEvents();
                                }, 1000);
                            }
                        }, 1000);
                    } else if (data.needsConfig) {
                        alert('Please configure Azure AD settings first in the Azure AD section.');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    alert('Login failed: ' + error.message);
                });
        }

        function loginDirectly() {
            console.log('Starting direct login...');
            window.location.href = '/api/v1/auth/direct-login';
        }

        function logout() {
            fetch('/api/v1/auth/logout', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('Logout response:', data);
                    if (data.success) {
                        checkAuthStatus();
                        loadCalendarEvents();
                    }
                })
                .catch(error => console.error('Logout error:', error));
        }

        function checkAuthStatus() {
            fetch('/api/v1/auth/profile')
                .then(response => response.json())
                .then(data => {
                    console.log('Auth status:', data);
                    const profileContent = document.getElementById('profileContent');
                    const authNotice = document.getElementById('calendarAuthNotice');
                    
                    if (data.isAuthenticated && data.user) {
                        profileContent.innerHTML = `
                            <div class="profile-user">
                                <div class="profile-user-info">
                                    <h4>${data.user.displayName || data.user.userPrincipalName}</h4>
                                    <p>${data.user.userPrincipalName}</p>
                                </div>
                            </div>
                            <div class="profile-action">
                                <button onclick="logout()" class="btn danger">Sign out</button>
                            </div>
                        `;
                        authNotice.style.display = 'none';
                    } else {
                        profileContent.innerHTML = `
                            <div class="profile-item">Not signed in</div>
                            <div class="profile-action">
                                <button onclick="loginToMicrosoft()" class="btn">Sign in with Microsoft</button>
                                <button onclick="loginDirectly()" class="btn" style="background: #e67e22; margin-top: 5px;">Direct Sign In</button>
                            </div>
                        `;
                        authNotice.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Auth status error:', error);
                    const authNotice = document.getElementById('calendarAuthNotice');
                    authNotice.style.display = 'block';
                });
        }

        function loadCalendarEvents() {
            const eventsContainer = document.getElementById('calendarEvents');
            eventsContainer.innerHTML = '<p>Loading calendar events...</p>';
            
            fetch('/api/v1/calendar/events')
                .then(response => response.json())
                .then(data => {
                    console.log('Calendar response:', data);
                    if (data.success && data.events) {
                        if (data.events.length === 0) {
                            eventsContainer.innerHTML = '<p>No upcoming Teams meetings found in the next 7 days.</p>';
                        } else {
                            eventsContainer.innerHTML = data.events.map(event => {
                                const startDate = new Date(event.start.dateTime);
                                const endDate = new Date(event.end.dateTime);
                                const isDemo = data.source !== 'microsoft-graph';
                                
                                return `
                                    <div class="calendar-event">
                                        <div class="event-title">${event.subject}</div>
                                        <div class="event-time">
                                            ${startDate.toLocaleDateString()} 
                                            ${startDate.toLocaleTimeString()} - ${endDate.toLocaleTimeString()}
                                        </div>
                                        ${event.isOnlineMeeting ? '<span class="event-type">Teams Meeting</span>' : ''}
                                        ${isDemo ? '<span style="background: #e67e22;" class="event-type">Demo Data</span>' : '<span style="background: #27ae60;" class="event-type">Live Data</span>'}
                                    </div>
                                `;
                            }).join('');
                        }
                    } else if (data.needsAuth) {
                        eventsContainer.innerHTML = '<div class="auth-notice"><p>' + (data.message || 'Authentication required') + '</p></div>';
                        document.getElementById('calendarAuthNotice').style.display = 'block';
                    } else if (data.needsConfig) {
                        eventsContainer.innerHTML = '<div class="error-notice"><p>' + (data.message || 'Configuration required') + '</p></div>';
                    } else {
                        eventsContainer.innerHTML = '<p>Error loading calendar events: ' + (data.message || 'Unknown error') + '</p>';
                    }
                })
                .catch(error => {
                    console.error('Calendar error:', error);
                    eventsContainer.innerHTML = '<p>Error loading calendar events. Please check your connection and try again.</p>';
                });
        }

        // Load OneDrive Recordings
        function loadRecordings() {
            const recordingsContainer = document.getElementById('recordingsList');
            const authNotice = document.getElementById('recordingsAuthNotice');
            recordingsContainer.innerHTML = '<p>Loading recordings from OneDrive...</p>';
            
            fetch('/api/v1/recordings')
                .then(response => response.json())
                .then(data => {
                    console.log('Recordings response:', data);
                    if (data.success && data.recordings) {
                        authNotice.style.display = 'none';
                        if (data.recordings.length === 0) {
                            recordingsContainer.innerHTML = '<p>No recordings found in your OneDrive. Teams meeting recordings will appear here once you record meetings.</p>';
                        } else {
                            recordingsContainer.innerHTML = `
                                <p style="margin-bottom: 15px; color: #27ae60;"><strong>Found ${data.count} recording(s)</strong> for user: ${data.user}</p>
                                ${data.recordings.map(recording => `
                                    <div class="calendar-event">
                                        <div class="event-title">${recording.name}</div>
                                        <div class="event-time">
                                            Size: ${recording.sizeFormatted} | 
                                            Modified: ${new Date(recording.modifiedAt).toLocaleDateString()}
                                        </div>
                                        <div style="margin-top: 10px;">
                                            <a href="/api/v1/recordings/${recording.id}/download?redirect=true" class="btn" style="text-decoration: none; margin-right: 5px; padding: 5px 10px; font-size: 12px;">Download</a>
                                            <a href="${recording.webUrl}" target="_blank" class="btn" style="text-decoration: none; background: #27ae60; padding: 5px 10px; font-size: 12px;">Open in OneDrive</a>
                                            <button onclick="getRecordingTranscript('${recording.id}')" class="btn" style="background: #9b59b6; padding: 5px 10px; font-size: 12px; margin-left: 5px;">Get Transcript</button>
                                        </div>
                                        <div id="transcript-${recording.id}" style="margin-top: 10px; display: none;"></div>
                                    </div>
                                `).join('')}
                            `;
                        }
                    } else if (data.needsAuth) {
                        authNotice.style.display = 'block';
                        recordingsContainer.innerHTML = '<div class="auth-notice"><p>' + (data.message || 'Please sign in to access OneDrive recordings') + '</p></div>';
                    } else {
                        recordingsContainer.innerHTML = '<div class="error-notice"><p>Error: ' + (data.message || 'Unknown error') + '</p></div>';
                    }
                })
                .catch(error => {
                    console.error('Recordings error:', error);
                    recordingsContainer.innerHTML = '<p>Error loading recordings. Please check your connection and try again.</p>';
                });
        }

        // Get recording transcript
        function getRecordingTranscript(recordingId) {
            const transcriptDiv = document.getElementById('transcript-' + recordingId);
            transcriptDiv.style.display = 'block';
            transcriptDiv.innerHTML = '<p>Loading transcript...</p>';
            
            fetch('/api/v1/recordings/' + recordingId + '/transcript')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.transcripts && data.transcripts.length > 0) {
                        transcriptDiv.innerHTML = `
                            <div style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
                                <strong>Transcripts found:</strong>
                                <ul style="margin-top: 5px; padding-left: 20px;">
                                    ${data.transcripts.map(t => `
                                        <li><a href="${t.downloadUrl}" target="_blank">${t.name}</a></li>
                                    `).join('')}
                                </ul>
                            </div>
                        `;
                    } else {
                        transcriptDiv.innerHTML = '<p style="color: #7f8c8d;">No transcript found for this recording.</p>';
                    }
                })
                .catch(error => {
                    transcriptDiv.innerHTML = '<p style="color: #e74c3c;">Error loading transcript.</p>';
                });
        }

        function checkStatus() {
            console.log('Checking system status...');
            fetch('/api/v1/setup/status')
                .then(response => {
                    console.log('Status response:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Status data:', data);
                    if (data.success && data.status) {
                        updateStatusCards(data.status);
                    } else {
                        console.error('Invalid status response:', data);
                        setAllStatusError('Invalid response');
                    }
                })
                .catch(error => {
                    console.error('Status check error:', error);
                    setAllStatusError('Connection failed');
                });
        }

        function updateStatusCards(status) {
            const statusMap = {
                azure: 'Azure AD',
                storage: 'Storage', 
                tts: 'TTS',
                n8n: 'N8N',
                database: 'Database',
                redis: 'Redis'
            };

            Object.entries(statusMap).forEach(([key, name]) => {
                const card = document.getElementById(`status-${key}`);
                const textElement = card.querySelector('.status-text');
                
                card.className = 'status-card ' + (status[key] ? 'connected' : 'error');
                textElement.textContent = status[key] ? '✅ Configured' : '❌ Not configured';
            });
        }

        function setAllStatusError(message) {
            const statusCards = document.querySelectorAll('.status-card');
            statusCards.forEach(card => {
                card.className = 'status-card error';
                const textElement = card.querySelector('.status-text');
                textElement.textContent = `❌ ${message}`;
            });
        }

        // Configuration save functions with feedback
        function saveAzureConfig() {
            const data = {
                tenantId: document.getElementById('azure-tenant-id').value,
                clientId: document.getElementById('azure-client-id').value,
                clientSecret: document.getElementById('azure-client-secret').value
            };

            showConfigResult('azureConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/azure', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('azureConfigResult', '✅ Azure AD configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('azureConfigResult', '❌ Failed to save Azure AD configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('azureConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function saveStorageConfig() {
            const data = {
                type: document.getElementById('storage-type').value,
                supabaseUrl: document.getElementById('supabase-url').value,
                supabaseKey: document.getElementById('supabase-key').value,
                supabaseBucket: document.getElementById('supabase-bucket').value
            };

            showConfigResult('storageConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/storage', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('storageConfigResult', '✅ Storage configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('storageConfigResult', '❌ Failed to save storage configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('storageConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function saveTTSConfig() {
            const data = {
                provider: document.getElementById('tts-provider').value,
                apiKey: document.getElementById('tts-api-key').value
            };

            showConfigResult('ttsConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/tts', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('ttsConfigResult', '✅ TTS configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('ttsConfigResult', '❌ Failed to save TTS configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('ttsConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function saveN8NConfig() {
            const data = {
                webhookUrl: document.getElementById('n8n-webhook-url').value
            };

            showConfigResult('n8nConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/n8n', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('n8nConfigResult', '✅ N8N configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('n8nConfigResult', '❌ Failed to save N8N configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('n8nConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function saveDatabaseConfig() {
            const data = {
                host: document.getElementById('db-host').value,
                port: parseInt(document.getElementById('db-port').value),
                name: document.getElementById('db-name').value,
                username: document.getElementById('db-username').value,
                password: document.getElementById('db-password').value,
                ssl: true
            };

            showConfigResult('databaseConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/database', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('databaseConfigResult', '✅ Database configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('databaseConfigResult', '❌ Failed to save database configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('databaseConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function saveRedisConfig() {
            const data = {
                host: document.getElementById('redis-host').value,
                port: parseInt(document.getElementById('redis-port').value),
                password: document.getElementById('redis-password').value
            };

            showConfigResult('redisConfigResult', 'Saving...', 'checking');
            
            fetch('/api/v1/setup/redis', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showConfigResult('redisConfigResult', '✅ Redis configuration saved successfully!', 'success');
                    setTimeout(checkStatus, 1000);
                } else {
                    showConfigResult('redisConfigResult', '❌ Failed to save Redis configuration', 'error');
                }
            })
            .catch(error => {
                console.error('Save error:', error);
                showConfigResult('redisConfigResult', '❌ Error saving configuration', 'error');
            });
        }

        function showConfigResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}-notice" style="margin-top: 15px;"><p>${message}</p></div>`;
            
            if (type === 'success') {
                setTimeout(() => {
                    element.innerHTML = '';
                }, 3000);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded, initializing...');
            checkAuthStatus();
            loadCalendarEvents();
            checkStatus();
        });

        // Auto-refresh status every 30 seconds
        setInterval(checkStatus, 30000);
    </script>
</body>
</html>
